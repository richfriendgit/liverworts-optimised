library(shiny)
library(readr)
library(utils)   # for URLencode
# ---- Version metadata (update these on each release) ----
APP_NAME    <- "Common Liverwort ID App"
APP_VERSION <- "v1.1.7 – Optimized Images"
APP_DATE    <- "2026-01-16"
# --- GitHub locations ---
base_url <- "https://raw.githubusercontent.com/richfriendgit/liverworts-optimised/main/"
github_csv_url <- paste0(base_url, "Liverworts.csv")
# Load CSV directly from GitHub
plants <- read_csv(github_csv_url, show_col_types = FALSE)
library(shiny)
library(readr)
library(utils)   # for URLencode
# ---- Version metadata (update these on each release) ----
APP_NAME    <- "Common Liverwort ID App"
APP_VERSION <- "v1.1.7 – Optimized Images"
APP_DATE    <- "2026-01-16"
# --- GitHub locations ---
base_url <- "https://raw.githubusercontent.com/richfriendgit/liverworts-optimised/main/"
github_csv_url <- paste0(base_url, "Liverworts.csv")
# Load CSV directly from GitHub
plants <- read_csv(github_csv_url, show_col_types = FALSE)
# Safe infix for NULL
`%||%` <- function(a, b) if (is.null(a)) b else a
ui <- fluidPage(
# Theme, spacing, inline version header
tags$head(
tags$style(HTML("
/* Headings in Dark Forest Green */
h1, h2, h3, h4, h5 {
color: #2E7D32;
margin-top: 10px;
margin-bottom: 6px;
}
/* App header row: title left, version right */
.app-header {
display: flex;
align-items: flex-end;
justify-content: space-between;
gap: 12px;
border-bottom: 0;
margin-bottom: 10px;
}
#version-inline {
font-size: 12px;
color: rgba(46, 125, 50, 0.65);
font-weight: 400;
white-space: nowrap;
user-select: none;
}
/* Buttons */
.btn {
border: 2px solid #2E7D32 !important;
color: #2E7D32 !important;
background-color: white !important;
margin-bottom: 6px !important;
padding: 8px 10px !important;
}
.btn:hover { background-color: #2E7D32 !important; color: white !important; }
/* Inline button row */
.inline-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
/* Icon button styles */
.btn-icon {
padding: 8px !important;
min-width: 40px; min-height: 40px;
display: inline-flex; align-items: center; justify-content: center;
}
.btn-icon .fa { margin-right: 0 !important; }
/* Text outputs */
.shiny-text-output { margin: 2px 0 4px 0 !important; font-size: 14px; }
/* Sidebar padding */
.well { padding: 10px 10px 8px 10px !important; }
/* Image responsive + centred */
.img-wrap { text-align: center; }
.img-wrap img { max-width: 100%; height: auto; border-radius: 6px; }
/* Photographer credit */
.photo-credit {
margin-top: 6px;
font-size: 12px;
color: rgba(0, 0, 0, 0.55);
font-style: italic;
text-align: center;
}
/* Quiz modal styles */
.quiz-wrap { text-align: center; }
.quiz-wrap img { max-width: 100%; height: auto; border-radius: 6px; }
.quiz-ans  { margin-top: 8px; text-align: left; }
.quiz-ans h4 { color:#2E7D32; margin: 6px 0; }
.quiz-buttons { display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
"))
),
# Custom header row (title left, version right)
div(class = "app-header",
h2(APP_NAME),
span(id = "version-inline", "v1.1.7")
),
sidebarLayout(
sidebarPanel(
actionButton("reveal_family",  "Family"),
actionButton("reveal_species", "Species features"),
actionButton("reveal_latin",   "Latin name"),
actionButton("reveal_common",  "Common name"),
div(class = "inline-row",
actionButton("reveal_habitat", "Habitat"),
actionButton("next_photo",     "Next image"),
actionButton("prev_photo",     "Back"),
actionButton(
inputId = "open_quiz",
label   = NULL,
icon    = icon("graduation-cap"),
title   = "Quiz mode (flashcards)",
class   = "btn btn-icon"
)
),
tags$hr(),
h4("Details:"),
textOutput("family_out"),
textOutput("species_out"),
textOutput("latin_out"),
textOutput("common_out"),
textOutput("habitat_out")
),
mainPanel(
div(class = "img-wrap", uiOutput("image_ui"))
)
)
)
server <- function(input, output, session) {
rv <- reactiveValues(
family  = "",
species = "",
latin   = "",
common  = "",
habitat = ""
)
output$family_out  <- renderText(rv$family)
output$species_out <- renderText(rv$species)
output$latin_out   <- renderText(rv$latin)
output$common_out  <- renderText(rv$common)
output$habitat_out <- renderText(rv$habitat)
nav <- reactiveValues(history = integer(0), pos = 0)
reveal_store <- reactiveValues(data = list())
initial_index <- sample(seq_len(nrow(plants)), 1)
nav$history <- c(initial_index)
nav$pos <- 1
current_index <- reactive({
validate(need(length(nav$history) >= nav$pos && nav$pos >= 1, "No image"))
nav$history[nav$pos]
})
save_reveals_for <- function(idx) {
key <- as.character(idx)
reveal_store$data[[key]] <- list(
family  = rv$family,
species = rv$species,
latin   = rv$latin,
common  = rv$common,
habitat = rv$habitat
)
}
load_reveals_for <- function(idx) {
key <- as.character(idx)
saved <- reveal_store$data[[key]]
if (is.null(saved)) {
rv$family  <- ""
rv$species <- ""
rv$latin   <- ""
rv$common  <- ""
rv$habitat <- ""
} else {
rv$family  <- saved$family
rv$species <- saved$species
rv$latin   <- saved$latin
rv$common  <- saved$common
rv$habitat <- saved$habitat
}
}
# Main image + photographer credit
output$image_ui <- renderUI({
idx <- current_index()
plant <- plants[idx, ]
img_src <- build_image_url(base_url, plant$image)
photographer <- plant$photo %||% ""
tagList(
tags$img(src = img_src, alt = "Liverwort image"),
if (nzchar(photographer)) {
tags$div(class = "photo-credit", paste("Picture by:", photographer))
}
)
})
observeEvent(input$reveal_family,  {
idx <- current_index(); rv$family  <- plants[idx, ]$family_features  %||% ""; save_reveals_for(idx)
})
observeEvent(input$reveal_species, {
idx <- current_index(); rv$species <- plants[idx, ]$species_features %||% ""; save_reveals_for(idx)
})
observeEvent(input$reveal_latin,   {
idx <- current_index(); rv$latin   <- plants[idx, ]$latin_name       %||% ""; save_reveals_for(idx)
})
observeEvent(input$reveal_common,  {
idx <- current_index(); rv$common  <- plants[idx, ]$common_name      %||% ""; save_reveals_for(idx)
})
observeEvent(input$reveal_habitat, {
idx <- current_index(); rv$habitat <- plants[idx, ]$habitat          %||% ""; save_reveals_for(idx)
})
observeEvent(input$next_photo, {
if (nav$pos < length(nav$history)) {
nav$pos <- nav$pos + 1
} else {
seen <- unique(nav$history)
pool <- setdiff(seq_len(nrow(plants)), seen)
next_idx <- if (length(pool) > 0) sample(pool, 1) else sample(seq_len(nrow(plants)), 1)
nav$history <- c(nav$history, next_idx)
nav$pos <- nav$pos + 1
}
load_reveals_for(current_index())
})
observeEvent(input$prev_photo, {
if (nav$pos > 1) { nav$pos <- nav$pos - 1; load_reveals_for(current_index()) }
})
quiz <- reactiveValues(seen = integer(0), current = NULL, revealed = FALSE)
pick_quiz_index <- function() {
all_idx <- seq_len(nrow(plants))
pool <- setdiff(all_idx, unique(quiz$seen))
if (length(pool) == 0) {
quiz$seen <- integer(0)
pool <- all_idx
showNotification("Quiz reset: all cards seen. Starting a fresh cycle.", type = "message", duration = 3)
}
sample(pool, 1)
}
observeEvent(input$open_quiz, {
quiz$current <- pick_quiz_index()
quiz$revealed <- FALSE
showModal(modalDialog(easyClose = TRUE, size = "l", footer = NULL, uiOutput("quiz_card_ui")))
})
output$quiz_card_ui <- renderUI({
req(quiz$current)
plant <- plants[quiz$current, ]
img_src <- build_image_url(base_url, plant$image)
photographer <- plant$photo %||% ""
tagList(
div(
class = "quiz-wrap",
tags$img(src = img_src, alt = "Quiz image"),
if (nzchar(photographer)) {
div(class = "photo-credit", paste("Picture by:", photographer))
}
),
div(class = "quiz-buttons",
actionButton("quiz_reveal", "Show answer"),
actionButton("quiz_next",   "Next card"),
modalButton("Close")
),
if (quiz$revealed) {
div(class = "quiz-ans",
h4("Answer"),
p(strong("Latin name: "), plant$latin_name %||% ""),
p(strong("Common name: "), plant$common_name %||% ""),
if (nzchar(plant$species_features %||% "")) p(strong("Key species features: "), plant$species_features %||% "")
)
}
)
})
observeEvent(input$quiz_reveal, { quiz$revealed <- TRUE })
observeEvent(input$quiz_next, {
req(quiz$current)
quiz$seen <- c(quiz$seen, quiz$current)
quiz$current <- pick_quiz_index()
quiz$revealed <- FALSE
})
}
shinyApp(ui, server)
